#!/bin/env sh
# Outputs cpu usage %

[ -e "$HOME/.local/bin/status/sbcol" ] && . "$HOME"/.local/bin/status/sbcol

cpu_usage(){
    read -r cpu a b c previdle rest < /proc/stat
    prevtotal=$((a+b+c+previdle))
    sleep 0.5
    read -r cpu a b c idle rest < /proc/stat
    total=$((a+b+c+idle))
    usage=$((100*( (total-prevtotal) - (idle-previdle) ) / (total-prevtotal) ))
}

case $BLOCK_BUTTON in
    1) notify-send "CPU hogs(100% per core)" "$(ps axch -o cmd:15,%cpu --sort=-%cpu | head)" ;;
    3) setsid -f "$TERMINAL" -T termfloat -e htop & ;;
esac

cpu_usage

if [ "$usage" -ge 84 ]; then
    color="#ff1600"
elif [ "$usage" -ge 70 ]; then
    color="#ff9600"
fi

display "$usage%" "$color" || echo "$usage%"
