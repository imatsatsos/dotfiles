#!/usr/bin/env bash
# Outputs connected wifi state, signal % and SSID
# output is color graded
# Left click: toggle SSID output
# Right click: opens nmcli to manage connections
# Middle click: toggles wifi state
# DEPENDS: iw to display info, NetworkManager for connection handling

[ -e "$HOME/.local/bin/status/sbcol" ] && . "$HOME"/.local/bin/status/sbcol

if [ -z "$INTERFACE" ] ; then
    INTERFACE="${BLOCK_INSTANCE:-wlp0s20f3}"
fi

COLOR_GE80=${COLOR_GE80:-#95F91F}
COLOR_GE60=${COLOR_GE60:-#F9F11F}
COLOR_GE40=${COLOR_GE40:-#F9841F}
COLOR_LOWR=${COLOR_LOWR:-#F91F28}
COLOR_DOWN=${COLOR_DOWN:-#F91F28}
LABEL="󰖩"

# As per #36 -- It is transparent: e.g. if the machine has no battery or wireless
# connection (think desktop), the corresponding block should not be displayed.
[ ! -d /sys/class/net/"$INTERFACE"/wireless ] && exit

toggle_wifi() {
    if [ "$(cat /sys/class/net/"$INTERFACE"/operstate)" = 'down' ]; then
	nmcli device up	"$INTERFACE" >/dev/null 2>&1
	notify-send -a "sysui" -t 4000 "󰖩 Wifi on"
    else
	nmcli device down "$INTERFACE" >/dev/null 2>&1
	notify-send -a "sysui" -t 4000 "󰖪 Wifi off"
    fi
}

case "$BLOCK_BUTTON" in
    2) toggle_wifi ;;
    3) setsid -f "$TERMINAL" -T termfloat -e nmtui & ;;
esac

# If the wifi interface exists but no connection is active, "down" shall be displayed.
if [ "$(cat /sys/class/net/"$INTERFACE"/operstate)" = 'down' ]; then
    display "down" "$COLOR_DOWN" "󰖪" || echo "󰖪down"
    exit 0
fi


#SSID=$(iw "$INTERFACE" link | awk '/SSID: / {$1=""; print $0}')
SSID="$(iw dev "$INTERFACE" link | grep 'SSID:' | cut -c 8-)"
#SHORT_SSID="*${SSID: -3}"
QUALITY=$(iw "${INTERFACE}" link | grep 'dBm$' | grep -Eoe '-[0-9]{2}' | awk '{print  ($1 > -50 ? 100 :($1 < -100 ? 0 : ($1+100)*2))}')
QUALITYdBm=$(iw "${INTERFACE}" link | grep dBm | grep -Eoe '-[0-9]{2} dBm')
IP=$(ip address show wlp0s20f3 | grep -Eo 'inet [0-9.]+' | awk '{print $2}')

OUTPUT="$QUALITY"

# color
if [ "$QUALITY" -ge 80 ]; then 
    test=''
elif [ "$QUALITY" -ge 60 ]; then
    COLOR=$COLOR_GE60
elif [ "$QUALITY" -ge 40 ]; then
    COLOR=$COLOR_GE40
else
    COLOR=$COLOR_LOWR
fi

case "$BLOCK_BUTTON" in
    1) notify-send -a "sysui" -t 4000 "$SSID" "$QUALITY% (${QUALITYdBm})\n$IP" ;;
esac

display "$OUTPUT" "$COLOR" || echo "$OUTPUT"
